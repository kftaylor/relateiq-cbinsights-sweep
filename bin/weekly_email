#!/usr/bin/env ruby
$stdout.sync = true
require 'rubygems'
require 'bundler'

Bundler.require

require 'csv'
require 'date'
require 'erb'
require '../company'
require '../import'
require '../import_result'
require 'sequel/extensions/pg_hstore'

Mail.defaults do
  delivery_method :smtp, {
      :port => ENV['MAILGUN_SMTP_PORT'],
      :address => ENV['MAILGUN_SMTP_SERVER'],
      :user_name => ENV['MAILGUN_SMTP_LOGIN'],
      :password => ENV['MAILGUN_SMTP_PASSWORD'],
      :authentication => :plain
  }
end

Sequel.extension(:pg_hstore, :pg_hstore_ops, :pg_array)
DB = Sequel.connect(ENV['DATABASE_URL'])

companies = DB[:companies].where { created_at >= (Date.today - 7) }.all.map { |c| Company.from_db c }
Mail.deliver do
  to 'taylor.k.f@gmail.com'
  cc 'vic.ivanoff@gmail.com'
  from 'RelateIQ Robot <integration@relateiq-cbinsights-sweep.herokuapp.com>'
  subject 'Weekly RelateIQ email'
  text_part do
    companies_text = companies.length > 1 ? "#{companies.length} companies were" : 'one company was'
    email = "This week #{companies_text} successfully added to RelateIQ via CBinsights sweep:\n"
    companies.each_with_index do |c, i|
      email << c.to_email(i+1)
    end
    body email
  end
  html_part do
    layout = Tilt.new('../layout.erb')
    weekly_email_partial = Tilt.new('../weekly_email.erb')
    html = layout.render do
      weekly_email_partial.render(nil, companies: companies)
    end
    body html
  end
end